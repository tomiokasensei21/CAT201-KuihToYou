<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Kuih To You</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .admin-container { padding: 50px; font-family: sans-serif; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { padding: 15px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #e67e22; color: white; }
        .btn-add { background: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-edit { background: #2980b9; color: white; padding: 5px 10px; border: none; border-radius: 3px; margin-right: 5px; }
        .btn-delete { background: #c0392b; color: white; padding: 5px 10px; border: none; border-radius: 3px; }
    </style>
</head>
<body>

<div class="admin-container">
    <h1>Admin Panel: Manage Kuih Menu</h1>
    <button class="btn-add" onclick="addKuih()">+ Add New Kuih</button>

    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Price (RM)</th>
            <th>Stock (Units)</th> <th>Actions</th>
        </tr>
        </thead>
        <tbody id="kuihTableBody"></tbody>
    </table>
</div>

<script>
    let kuihList = [];

    // 1. LOAD DATA FROM TXT FILE ON START
    async function loadData() {
        try {
            const response = await fetch('admin-api'); // Calls doGet in AdminServlet
            kuihList = await response.json();
            renderTable();
        } catch (error) {
            console.error("Error loading data:", error);
        }
    }

    function renderTable() {
        const tableBody = document.getElementById('kuihTableBody');
        tableBody.innerHTML = "";
        kuihList.forEach((item, index) => {
            tableBody.innerHTML += `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${Number(item.price).toFixed(2)}</td>
                    <td>${item.stock}</td>
                    <td>
                        <button class="btn-edit" onclick="editKuih(${index})">Edit</button>
                        <button class="btn-delete" onclick="deleteKuih(${index})">Delete</button>
                    </td>
                </tr>`;
        });
    }

    // --- VALIDATION LOGIC (Stays the same) ---
    function validateInput(name, price, stock) {
        if (!name || !price || !stock) {
            Swal.showValidationMessage('All fields are required!');
            return false;
        }
        if (isNaN(price) || Number(price) <= 0) {
            Swal.showValidationMessage('Price must be a positive number!');
            return false;
        }
        if (isNaN(stock) || Number(stock) < 0 || !Number.isInteger(Number(stock))) {
            Swal.showValidationMessage('Stock must be a valid whole number!');
            return false;
        }
        return true;
    }

    // 2. ADD KUIH (Now sends to Servlet)
    async function addKuih() {
        const { value: formValues } = await Swal.fire({
            title: 'Add New Kuih',
            html:
                '<input id="swal-name" class="swal2-input" placeholder="Kuih Name">' +
                '<input id="swal-price" type="number" class="swal2-input" placeholder="Price (RM)">' +
                '<input id="swal-stock" type="number" class="swal2-input" placeholder="Initial Stock">',
            focusConfirm: false,
            showCancelButton: true,
            preConfirm: () => {
                const name = document.getElementById('swal-name').value;
                const price = document.getElementById('swal-price').value;
                const stock = document.getElementById('swal-stock').value;
                if (validateInput(name, price, stock)) {
                    return { name, price, stock };
                }
            }
        });

        if (formValues) {
            const params = new URLSearchParams();
            params.append('action', 'add');
            params.append('name', formValues.name);
            params.append('price', formValues.price);
            params.append('stock', formValues.stock);

            await fetch('admin-api', { method: 'POST', body: params });
            loadData(); // Reload table from TXT file
            Swal.fire('Success!', 'New Kuih saved to text file.', 'success');
        }
    }

    // 3. EDIT KUIH (Now sends to Servlet)
    async function editKuih(index) {
        const item = kuihList[index];
        const { value: formValues } = await Swal.fire({
            title: 'Edit Kuih & Stock',
            html:
                `<input id="swal-name" class="swal2-input" value="${item.name}">` +
                `<input id="swal-price" type="number" class="swal2-input" value="${item.price}">` +
                `<input id="swal-stock" type="number" class="swal2-input" value="${item.stock}">`,
            focusConfirm: false,
            showCancelButton: true,
            preConfirm: () => {
                const name = document.getElementById('swal-name').value;
                const price = document.getElementById('swal-price').value;
                const stock = document.getElementById('swal-stock').value;
                if (validateInput(name, price, stock)) {
                    return { id: item.id, name, price, stock };
                }
            }
        });

        if (formValues) {
            const params = new URLSearchParams();
            params.append('action', 'update');
            params.append('id', formValues.id);
            params.append('name', formValues.name);
            params.append('price', formValues.price);
            params.append('stock', formValues.stock);

            await fetch('admin-api', { method: 'POST', body: params });
            loadData();
            Swal.fire('Updated!', 'Stock and details updated in file.', 'success');
        }
    }

    // 4. DELETE KUIH (Now sends to Servlet)
    function deleteKuih(index) {
        const item = kuihList[index];
        Swal.fire({
            title: 'Are you sure?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete!'
        }).then(async (result) => {
            if (result.isConfirmed) {
                const params = new URLSearchParams();
                params.append('action', 'delete');
                params.append('id', item.id);

                await fetch('admin-api', { method: 'POST', body: params });
                loadData();
                Swal.fire('Deleted!', 'Item removed from text file.', 'success');
            }
        });
    }

    // Initial load when page opens
    loadData();
</script>
</body>
</html>